<!DOCTYPE html>
<html>
<head>
    <title>å€‹åˆ¥æ¨æ’­é™¤éŒ¯æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        pre { font-size: 12px; }
    </style>
    <script>
        async function runTests() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>é–‹å§‹æ¸¬è©¦...</p>';
            
            // æ¸¬è©¦ 1: æª¢æŸ¥ç¾¤çµ„è³‡æ–™
            try {
                const groupsResponse = await fetch('/api/groups');
                const groups = await groupsResponse.json();
                results.innerHTML += `
                    <div class="result success">
                        <h3>âœ… æ¸¬è©¦ 1: ç¾¤çµ„è³‡æ–™</h3>
                        <p>ç¾¤çµ„æ•¸é‡: ${groups.length}</p>
                        <pre>${JSON.stringify(groups, null, 2)}</pre>
                    </div>
                `;
                
                // æ¸¬è©¦ 2: æ¨¡æ“¬æ·»åŠ å€‹åˆ¥æ¨æ’­
                if (groups.length > 0) {
                    const testBroadcast = {
                        broadcasts: [{
                            groupId: groups[0].groupId,
                            groupName: groups[0].name,
                            message: "å€‹åˆ¥æ¨æ’­é™¤éŒ¯æ¸¬è©¦ - " + new Date().toLocaleTimeString(),
                            images: []
                        }]
                    };
                    
                    // æ¸¬è©¦å„²å­˜åŠŸèƒ½
                    localStorage.setItem('individual-broadcasts', JSON.stringify([testBroadcast.broadcasts[0]]));
                    const saved = localStorage.getItem('individual-broadcasts');
                    
                    results.innerHTML += `
                        <div class="result success">
                            <h3>âœ… æ¸¬è©¦ 2: æœ¬åœ°å„²å­˜</h3>
                            <p>è³‡æ–™å·²å„²å­˜åˆ° localStorage</p>
                            <pre>å„²å­˜çš„è³‡æ–™: ${saved}</pre>
                        </div>
                    `;
                    
                    // æ¸¬è©¦ 3: API ç™¼é€ï¼ˆä¸å¯¦éš›ç™¼é€ï¼Œåªæ¸¬è©¦æ ¼å¼ï¼‰
                    try {
                        const apiResponse = await fetch('/api/broadcast-multiple', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(testBroadcast)
                        });
                        const result = await apiResponse.json();
                        
                        results.innerHTML += `
                            <div class="result ${result.success ? 'success' : 'error'}">
                                <h3>${result.success ? 'âœ…' : 'âŒ'} æ¸¬è©¦ 3: API å‘¼å«</h3>
                                <p>API å›æ‡‰ç‹€æ…‹: ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}</p>
                                <pre>${JSON.stringify(result, null, 2)}</pre>
                            </div>
                        `;
                    } catch (apiError) {
                        results.innerHTML += `
                            <div class="result error">
                                <h3>âŒ æ¸¬è©¦ 3: API å‘¼å«</h3>
                                <p>API éŒ¯èª¤: ${apiError.message}</p>
                            </div>
                        `;
                    }
                } else {
                    results.innerHTML += `
                        <div class="result error">
                            <h3>âŒ ç„¡æ³•é€²è¡Œå¾ŒçºŒæ¸¬è©¦</h3>
                            <p>æ²’æœ‰å¯ç”¨çš„ç¾¤çµ„è³‡æ–™</p>
                        </div>
                    `;
                }
                
                // æ¸¬è©¦ 4: æª¢æŸ¥æœ€è¿‘æ´»å‹•
                const activitiesResponse = await fetch('/api/activities');
                const activities = await activitiesResponse.json();
                results.innerHTML += `
                    <div class="result">
                        <h3>ğŸ“Š æ¸¬è©¦ 4: ç³»çµ±æ´»å‹•</h3>
                        <p>æ´»å‹•è¨˜éŒ„æ•¸é‡: ${activities.length}</p>
                        <pre>${JSON.stringify(activities, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += `
                    <div class="result error">
                        <h3>âŒ æ¸¬è©¦å¤±æ•—</h3>
                        <p>éŒ¯èª¤: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function clearStorage() {
            localStorage.removeItem('individual-broadcasts');
            document.getElementById('storageResult').innerHTML = 'âœ… localStorage å·²æ¸…ç©º';
        }
        
        function checkStorage() {
            const data = localStorage.getItem('individual-broadcasts');
            document.getElementById('storageResult').innerHTML = 
                data ? `ğŸ“¦ å„²å­˜è³‡æ–™: ${data}` : 'ğŸ“­ localStorage ç‚ºç©º';
        }
    </script>
</head>
<body>
    <h1>å€‹åˆ¥æ¨æ’­åŠŸèƒ½é™¤éŒ¯æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>è‡ªå‹•æ¸¬è©¦</h2>
        <button onclick="runTests()">åŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>æœ¬åœ°å„²å­˜æ¸¬è©¦</h2>
        <button onclick="checkStorage()">æª¢æŸ¥ localStorage</button>
        <button onclick="clearStorage()">æ¸…ç©º localStorage</button>
        <div id="storageResult"></div>
    </div>
</body>
</html>