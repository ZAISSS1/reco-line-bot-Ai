<!DOCTYPE html>
<html>
<head>
    <title>LINE API ç‹€æ…‹ç›£æ§</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: #fff; }
        .status-box { background: #2a2a2a; padding: 20px; border-radius: 8px; margin: 15px 0; }
        .success { border-left: 4px solid #4CAF50; }
        .warning { border-left: 4px solid #FFC107; }
        .error { border-left: 4px solid #F44336; }
        .info { border-left: 4px solid #2196F3; }
        h1 { color: #4CAF50; }
        .timer { font-size: 24px; font-weight: bold; text-align: center; padding: 10px; }
        .test-button { background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .normal-button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .disabled { background: #666; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>ğŸ“Š LINE API ç‹€æ…‹ç›£æ§ä¸­å¿ƒ</h1>
    
    <div class="status-box info">
        <h2>â° é™åˆ¶æ™‚é–“è¿½è¹¤</h2>
        <p>å¾ç¬¬ä¸€æ¬¡ 429 éŒ¯èª¤é–‹å§‹è¨ˆæ™‚ï¼š</p>
        <div class="timer" id="timer">Loading...</div>
        <p><strong>é ä¼°æ¢å¾©æ™‚é–“ï¼š</strong> 5-30 åˆ†é˜ï¼ˆæ¨™æº–æƒ…æ³ï¼‰</p>
    </div>
    
    <div class="status-box warning">
        <h2>ğŸš¨ ç•¶å‰ç‹€æ…‹</h2>
        <ul>
            <li><strong>æ­£å¸¸æ¨¡å¼ï¼š</strong> <span style="color: #F44336;">âŒ LINE API 429 é™åˆ¶ä¸­</span></li>
            <li><strong>æ¸¬è©¦æ¨¡å¼ï¼š</strong> <span style="color: #4CAF50;">âœ… å®Œå…¨æ­£å¸¸é‹ä½œ</span></li>
            <li><strong>ç¾¤çµ„è³‡æ–™ï¼š</strong> <span style="color: #4CAF50;">âœ… 2 å€‹ç¾¤çµ„å·²è¼‰å…¥</span></li>
            <li><strong>åŠŸèƒ½é‚è¼¯ï¼š</strong> <span style="color: #4CAF50;">âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸</span></li>
        </ul>
    </div>
    
    <div class="status-box success">
        <h2>ğŸ¯ ç«‹å³å¯ç”¨çš„è§£æ±ºæ–¹æ¡ˆ</h2>
        <p><strong>æ‚¨ç¾åœ¨å¯ä»¥å®Œæ•´ä½¿ç”¨å€‹åˆ¥æ¨æ’­åŠŸèƒ½ï¼š</strong></p>
        <ol>
            <li>åœ¨ç™¼é€æ¨¡å¼é¸æ“‡ã€Œæ¸¬è©¦æ¨¡å¼ã€</li>
            <li>è¨­å®šæ‰€æœ‰ç¾¤çµ„çš„å€‹åˆ¥è¨Šæ¯å’Œåœ–ç‰‡</li>
            <li>é»æ“Šã€Œæ¸¬è©¦ã€æŒ‰éˆ•æ¨¡æ“¬ç™¼é€</li>
            <li>æŸ¥çœ‹æ´»å‹•è¨˜éŒ„ç¢ºèªåŠŸèƒ½æ­£å¸¸</li>
            <li>ç­‰å¾… LINE API æ¢å¾©å¾Œåˆ‡æ›æ­£å¸¸æ¨¡å¼</li>
        </ol>
    </div>
    
    <div class="status-box info">
        <h2>ğŸ§ª å³æ™‚æ¸¬è©¦å·¥å…·</h2>
        <button class="test-button" onclick="testMode()">æ¸¬è©¦æ¨¡å¼ç™¼é€</button>
        <button class="normal-button" onclick="normalMode()" id="normalBtn">æ­£å¸¸æ¨¡å¼ç™¼é€</button>
        <button class="test-button" onclick="checkStatus()">æª¢æŸ¥ API ç‹€æ…‹</button>
        <div id="testResult" style="margin-top: 15px;"></div>
    </div>
    
    <script>
        let startTime = new Date('2025-07-24T10:06:00'); // ç¬¬ä¸€æ¬¡ 429 éŒ¯èª¤æ™‚é–“
        
        function updateTimer() {
            const now = new Date();
            const diff = now - startTime;
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('timer').textContent = `${minutes} åˆ† ${seconds} ç§’`;
            
            // é ä¼°æ¢å¾©æ™‚é–“é¡è‰²è®ŠåŒ–
            const timerEl = document.getElementById('timer');
            if (minutes < 5) {
                timerEl.style.color = '#F44336'; // ç´…è‰²
            } else if (minutes < 15) {
                timerEl.style.color = '#FFC107'; // é»ƒè‰²
            } else {
                timerEl.style.color = '#4CAF50'; // ç¶ è‰²
            }
        }
        
        async function testMode() {
            document.getElementById('testResult').innerHTML = 'æ¸¬è©¦ä¸­...';
            try {
                const response = await fetch('/api/broadcast-multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        broadcasts: [{
                            groupId: 'C02351aa1bf4cab610d59b0286f0922e2',
                            groupName: 'åŒ…æœˆå–®è¶Ÿ-Task',
                            message: 'ç‹€æ…‹ç›£æ§æ¸¬è©¦ - ' + new Date().toLocaleTimeString(),
                            images: []
                        }],
                        testMode: true
                    })
                });
                const result = await response.json();
                document.getElementById('testResult').innerHTML = 
                    `<div style="color: #4CAF50;">âœ… æ¸¬è©¦æ¨¡å¼æˆåŠŸï¼š${JSON.stringify(result, null, 2)}</div>`;
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div style="color: #F44336;">âŒ éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }
        
        async function normalMode() {
            document.getElementById('testResult').innerHTML = 'æª¢æŸ¥æ­£å¸¸æ¨¡å¼...';
            try {
                const response = await fetch('/api/broadcast-multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        broadcasts: [{
                            groupId: 'C02351aa1bf4cab610d59b0286f0922e2',
                            groupName: 'åŒ…æœˆå–®è¶Ÿ-Task',
                            message: 'API é™åˆ¶æª¢æŸ¥ - ' + new Date().toLocaleTimeString(),
                            images: []
                        }],
                        testMode: false
                    })
                });
                const result = await response.json();
                if (result.totalSent > 0) {
                    document.getElementById('testResult').innerHTML = 
                        `<div style="color: #4CAF50;">ğŸ‰ LINE API å·²æ¢å¾©ï¼æ­£å¸¸æ¨¡å¼å¯ç”¨</div>`;
                    document.getElementById('normalBtn').style.background = '#4CAF50';
                } else {
                    document.getElementById('testResult').innerHTML = 
                        `<div style="color: #FFC107;">â³ ä»åœ¨é™åˆ¶ä¸­ï¼š${JSON.stringify(result, null, 2)}</div>`;
                }
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div style="color: #F44336;">âŒ éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }
        
        async function checkStatus() {
            document.getElementById('testResult').innerHTML = 'æª¢æŸ¥ç³»çµ±ç‹€æ…‹...';
            try {
                const [groups, activities, stats] = await Promise.all([
                    fetch('/api/groups').then(r => r.json()),
                    fetch('/api/activities').then(r => r.json()),
                    fetch('/api/stats').then(r => r.json())
                ]);
                
                document.getElementById('testResult').innerHTML = `
                    <div style="color: #2196F3;">
                        <h4>ğŸ“Š ç³»çµ±ç‹€æ…‹</h4>
                        <p><strong>ç¾¤çµ„æ•¸é‡ï¼š</strong> ${groups.length}</p>
                        <p><strong>æ´»å‹•è¨˜éŒ„ï¼š</strong> ${activities.length}</p>
                        <p><strong>ç³»çµ±çµ±è¨ˆï¼š</strong> ${JSON.stringify(stats)}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('testResult').innerHTML = 
                    `<div style="color: #F44336;">âŒ éŒ¯èª¤ï¼š${error.message}</div>`;
            }
        }
        
        // æ¯ç§’æ›´æ–°è¨ˆæ™‚å™¨
        setInterval(updateTimer, 1000);
        updateTimer();
        
        // æ¯ 2 åˆ†é˜è‡ªå‹•æª¢æŸ¥ API ç‹€æ…‹
        setInterval(normalMode, 120000);
    </script>
</body>
</html>